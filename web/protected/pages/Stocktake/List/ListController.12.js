var PageJs=new Class.create;PageJs.prototype=Object.extend(new CRUDPageJs,{_getTitleRowData:function(){return this._titleRowData.serverMeasurement={ServeMeasurement:{name:"Server Measurement"}},this._titleRowData.unitPrice="Unit Price",this._titleRowData.totalPrice="Total Price",this._titleRowData.orderqty="Order QTY",this._titleRowData},init:function(){var t={};return t.me=this,t.me._htmlIDs.totalRow="total-row",t.me._bindSubmitButton(),t.me},_priceCalc:function(){var t={};return t.me=this,t.total=0,$("item-list-body").getElementsBySelector(".item_row").each(function(e){t.unitPrice=e.down('[save-item="unitPrice"]'),t.totalPrice=e.down('[save-item="totalPrice"]'),t.stocktakeShop=e.down('[save-item="stocktakeShop"]'),t.stocktakeStoreRoom=e.down('[save-item="stocktakeStoreRoom"]'),t.orderQty=e.down('[save-item="orderQty"]'),t.totalPriceValue=(accounting.unformat($F(t.stocktakeShop))+accounting.unformat($F(t.stocktakeStoreRoom))+accounting.unformat($F(t.orderQty)))*accounting.unformat($F(t.unitPrice)),t.totalPrice.setValue(accounting.formatMoney(t.totalPriceValue,"",2,"",".")),t.total+=accounting.unformat($F(t.totalPrice))}),$(t.me._htmlIDs.totalRow).down('[save-item="totalPrice"]').setValue(accounting.formatMoney(t.total,"",2,"",".")),t.me},_bindSubmitButton:function(){var t={};return t.me=this,t.btn=$("item-list").up(".panel").down('[type="submit"]'),t.btn.readAttribute("data-loading-text")||t.btn.writeAttribute("data-loading-text",'<i class="fa fa-spinner fa-spin"></i>'),t.btn?(t.btn.observe("click",function(){t.me._preSubmit(t.me._collectData(),t.btn)}),t.me):t.me},_preSubmit:function(t,e){var o={};return o.me=this,o.btn=e||null,o.confirmBoxContent=new Element("div",{"class":"pre-submit-box"}).insert({bottom:new Element("h4").update("Once you submit these data, then you will NOT be able to changed it any more.")}),o.confirmBoxFooter=new Element("div",{"class":"row pre-submit-box-footer"}).insert({bottom:new Element("span",{"class":"btn btn-primary col-sm-3","data-loading-text":'<i class="fa fa-spinner fa-spin"></i>'}).update("YES, continue.").observe("click",function(){o.btn&&(o.me._signRandID(o.btn),jQuery("#"+o.btn.id).button("loading")),$$(".pre-submit-box-footer .btn").each(function(t){o.me._signRandID(t),jQuery("#"+t.id).button("loading")}),o.me._submit(t,o.btn)})}).insert({bottom:new Element("span",{"class":"btn btn-default col-sm-3 pull-right","data-loading-text":'<i class="fa fa-spinner fa-spin"></i>'}).update("No, let me review it again.").observe("click",function(){o.me.hideModalBox()})}),o.me.showModalBox("Please confirm",o.confirmBoxContent,!1,o.confirmBoxFooter,!0),o.me},_submit:function(t,e){var o={};return o.me=this,o.btn=e||null,o.me.postAjax(o.me.getCallbackId("stocktake"),t,{onSuccess:function(t,e){try{o.result=o.me.getResp(e,!1,!0),o.result&&o.result.email&&o.result.asset&&(o.resultBox=new Element("div").insert({bottom:new Element("b",{"class":"success"}).update("An email will be send to :"+o.result.email)}).insert({bottom:"With an attached excel: "}).insert({bottom:new Element("a",{href:o.result.asset.url,target:"__BLANK"}).update(o.result.asset.filename)}),o.resultFooter=new Element("div",{"class":"text-center"}).insert({bottom:new Element("span",{"class":"btn btn-default"}).update("OK").observe("click",function(){window.location=document.URL})}),o.me.showModalBox("Success",o.resultBox,!1,o.resultFooter,!0))}catch(n){$$(".pre-submit-box").size()>0?$$(".pre-submit-box").first().insert({bottom:o.me.getAlertBox("Err",n).addClassName("alert-danger")}):o.me.showModalBox("Error","<pre>"+n+"</pre>"),null!==o.btn&&(o.me._signRandID(o.btn),jQuery("#"+o.btn.id).button("reset")),$$(".pre-submit-box-footer .btn").each(function(t){o.me._signRandID(t),jQuery("#"+t.id).button("reset")})}},onComplete:function(){}}),o.me},_collectData:function(){var t={};return t.me=this,t.data=[],$("item-list-body").getElementsBySelector(".item_row[item_id]").each(function(e){t.rowData=t.me._collectFormData(e,"save-item"),t.rowData.item=e.retrieve("data"),t.data.push(t.rowData)}),t.data},_getInput:function(t,e,o,n,a){var i={};return i.me=this,i.newDiv=new Element("div",{"class":"input-group"}).insert({bottom:new Element("input",{"class":"form-control","save-item":t,type:"text",disabled:a===!0}).setStyle("width: 100%").setValue(e)}),o&&i.newDiv.insert({top:new Element("div",{"class":"input-group-addon"}).update(o)}),n&&i.newDiv.insert({bottom:new Element("div",{"class":"input-group-addon"}).update(n)}),i.newDiv},getResultsOnComplete:function(){this._addTotalRow()},_addTotalRow:function(){var t={};return t.me=this,jQuery("#total-row").length>0?t.me:(t.row=t.me._getTitleRowData(),t.row.name="<b>Total</b>",t.row.serverMeasurement={ServeMeasurement:{name:null}},t.totalRow=t.me._getResultRow(t.row).writeAttribute("id",t.me._htmlIDs.totalRow),t.totalRow.getElementsBySelector("input").each(function(t){t.writeAttribute("disabled",!0)}),$("item-list-body").insert({bottom:t.totalRow}),t.me)},_getResultRow:function(t,e){var o={};if(o.me=this,o.isTitle=e||!1,o.tag=o.isTitle===!0?"strong":"span",o.row=new Element("span",{"class":"row"}).store("data",t).addClassName(t.active===!1&&o.isTitle===!1?"warning":"").addClassName("list-group-item").addClassName("item_row").writeAttribute("item_id",t.id).insert({bottom:new Element(o.tag,{"class":"name col-sm-2 col-xs-12"}).update(o.isTitle===!0?"Name":t.name)}).insert({bottom:new Element(o.tag,{"class":"unitPrice col-sm-2 col-xs-12"}).update(o.isTitle===!0?t.unitPrice:o.unitPrice=o.me._getInput("unitPrice",accounting.formatMoney(t.unitPrice,"",2,"","."),"$"))}).insert({bottom:new Element(o.tag,{"class":"totalPrice col-sm-2 col-xs-12"}).update(o.isTitle===!0?t.totalPrice:o.totalPrice=o.me._getInput("totalPrice",null,"$",null,!0))}).insert({bottom:new Element(o.tag,{"class":"stocktakeShop col-sm-2 col-xs-12"}).update(o.isTitle===!0?"Stocktake QTY<br/>(Shop)":o.stocktakeShop=o.me._getInput("stocktakeShop",null,null,t.serverMeasurement.ServeMeasurement.name))}).insert({bottom:new Element(o.tag,{"class":"stocktakeStoreRoom col-sm-2 col-xs-12"}).update(o.isTitle===!0?"Stocktake QTY<br/>(Store Room)":o.stocktakeStoreRoom=o.me._getInput("stocktakeStoreRoom",null,null,t.serverMeasurement.ServeMeasurement.name))}).insert({bottom:new Element(o.tag,{"class":"orderQty col-sm-2 col-xs-12"}).update(o.isTitle===!0?"Order QTY":o.orderQty=o.me._getInput("orderQty",null,null,t.serverMeasurement.ServeMeasurement.name))}),o.isTitle===!1&&o.me.preData.canEditUnitPrice===!1&&o.unitPrice.down("input").disable(),o.isTitle===!1&&(o.events=["keyup","change","wheel"],o.events.each(function(t){o.unitPrice.down("input").observe(t,function(){o.me._priceCalc()}),o.stocktakeShop.down("input").observe(t,function(){o.me._priceCalc()}),o.stocktakeStoreRoom.down("input").observe(t,function(){o.me._priceCalc()}),o.orderQty.down("input").observe(t,function(){o.me._priceCalc()})})),o.me._view&&""!==o.me._view)switch(o.me._view){case"stocktake":o.row.down(".orderQty").hide();break;case"placeorder":o.row.down(".stocktakeShop").hide(),o.row.down(".stocktakeStoreRoom").hide()}return o.row}});